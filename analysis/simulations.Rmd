---
title: "simulation figures"
author: "Julia Wrobel"
date: '`r format(Sys.time(), "%Y-%m-%d")`'
output:
  html_document: 
    code_folding: hide
    toc: true
    toc_float: true
hitheme: tomorrow
highlighter: highlight.js
---


# Overview

The goal of this analysis is to produce simulation figures for the paper.

```{r setup, message = FALSE, warning = FALSE}
rm(list = ls())

library(tidyverse)
library(stringr)
library(viridis)
library(gridExtra)
library(splines)
library(patchwork)
library(forcats)
library(refund)

knitr::opts_chunk$set(echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 9,
  fig.height = 4,
  fig.path = '../manuscript/figs/'
)

theme_set(theme_bw() + theme(legend.position = "none"))
source(here::here("../..", "201803_Hantman_Trajectories", "source", "simulated_paw_new.R"))
source(here::here("../..", "201803_Hantman_Trajectories", "source", "utils.R"))
source(here::here("../..", "201803_Hantman_Trajectories", "source", "estimate_flode_re.R"))
```


# Uncorrelated errors

## single dataset

```{r}
simulated_data = simulate_flode(N = 100, D = 50, x = "periodic", 
                                sigma_y0 = 5, sigma = 0.1, t_max = 1, 
                                alpha = 6, 
                                rand_int = FALSE,
                                seed = 6,
                                constant_beta = FALSE)
```


```{r}
dat = simulated_data$data 
```


## aggregate results


# Correlated errors

First simulate the data under 3 alpha values

```{r}
simulated_data2 = simulate_flode(N = 100, D = 50, x = "periodic", 
    																sigma_y0 = 5, sigma = 0.1, 
    																t_max = 1, 
    																alpha = 2, 
    																seed = 1,
    																lambda0 = 50, 
    																rand_int = TRUE,
    																constant_beta = FALSE)

simulated_data6 = simulate_flode(N = 100, D = 50, x = "periodic", 
    																sigma_y0 = 5, sigma = 0.1, 
    																t_max = 1, 
    																alpha = 6, 
    																seed = 1,
    																lambda0 = 50, 
    																rand_int = TRUE,
    																constant_beta = FALSE)

simulated_data12 = simulate_flode(N = 100, D = 50, x = "periodic", 
    																sigma_y0 = 5, sigma = 0.1, 
    																t_max = 1, 
    																alpha = 12, 
    																seed = 1,
    																lambda0 = 50, 
    																rand_int = TRUE,
    																constant_beta = FALSE)
```

Collect values and surfaces into one dataset

```{r}
dat = simulated_data2$data %>%
  select(trial, time, alpha_2 = value) %>%
  mutate(alpha_6 = simulated_data6$data$value,
         alpha_12 = simulated_data12$data$value)

t = s = seq(0, 1, length.out = 50)

surface2 = simulated_data2$surface %>% as_tibble() %>%
  mutate(t = t) %>% select(t, everything()) %>%
  gather(s, value, starts_with("s")) %>%
  mutate(s = as.numeric(str_remove(s, "s"))) %>%
  mutate(value = ifelse(s <= t, value, NA)) %>%  
  mutate(alpha = "alpha_2")

surface6 = simulated_data6$surface %>% as_tibble() %>%
  mutate(t = t) %>% select(t, everything()) %>%
  gather(s, value, starts_with("s")) %>%
  mutate(s = as.numeric(str_remove(s, "s"))) %>%
  mutate(value = ifelse(s <= t, value, NA)) %>%  
  mutate(alpha = "alpha_6")

surface12 = simulated_data12$surface %>% as_tibble() %>%
  mutate(t = t) %>% select(t, everything()) %>%
  gather(s, value, starts_with("s")) %>%
  mutate(s = as.numeric(str_remove(s, "s"))) %>%
  mutate(value = ifelse(s <= t, value, NA)) %>%  
  mutate(alpha = "alpha_12")

surface_df = bind_rows(surface2, surface6, surface12)
```


## single dataset

Here we show results at the dataset level

### simulated data

First we look at just the simulated data. 

```{r fig_simdata_RE, fig.height = 10, fig.width = 12}
values = dat %>%
  gather(alpha, value, starts_with("alpha")) %>%
  mutate(alpha = str_replace(alpha, "alpha_", "alpha = "),
         alpha = factor(alpha),
         alpha = fct_relevel(alpha, "alpha = 2", "alpha = 6", "alpha = 12")) %>%
  ggplot(aes(time, value, group = trial)) +
  geom_line(alpha = 0.25) +
  labs(y = "Y(t)") +
  facet_wrap(~ alpha)


surfaces = surface_df %>%  
  mutate(alpha = str_replace(alpha, "alpha_", "alpha = "),
         alpha = factor(alpha),
         alpha = fct_relevel(alpha, "alpha = 2", "alpha = 6", "alpha = 12")) %>%
  ggplot(aes(s, t)) + 
  geom_tile(aes(fill = value, col = value)) + 
  scale_fill_viridis_c() +
  scale_colour_viridis_c() +
  facet_wrap(~ alpha) +
  theme(legend.position = "bottom")

other = simulated_data2$data %>%
  select(trial, time, "forcing functions" = x, delta = re) %>%
  gather(param, value, "forcing functions":delta) %>%
  mutate(param = factor(param),
         param = fct_relevel(param, "forcing functions", "delta")) %>%
  ggplot(aes(time, value, group = trial)) +
  geom_line(alpha = 0.25) +
  facet_wrap(~ param, scales = "free")

 other + values + surfaces + plot_layout(ncol = 1)
```

### simulated data

Now we use the same data as above when $\alpha = 6$ and compare results from *flode* and *fhist*.

First, run the models. First *flode*:

```{r flode_mod, cache = TRUE}
dat = simulated_data6$data %>%
      mutate(int = 1) %>%
      group_by(trial) %>%
      mutate(y0 = first(value)) %>%
      ungroup()
    
flode_results = estimate_flode_re(dat, alpha0 = 6, forcing_functions = c("int","x"), 
    															max_iter = 200, 
    															tol = 0.00001, 
    															update_y0 = TRUE,
    															mle = TRUE,
    															lambda_init = 40)
```

Then *fhist*:

```{r fhist_mod, cache = TRUE}
dat = simulated_data6$data
make_pffr = function(data, covar = "x", random_int = FALSE){
      N = length(unique(data$trial))
      D = length(filter(data, trial == 1)$time)
      
      y_fhist = matrix(data$value, nrow = N, ncol = D, byrow = TRUE)
      x_fhist = matrix(data[[covar]], nrow = N, ncol = D, byrow = TRUE)
      
      y0 = data %>%
        group_by(trial) %>%
        summarize(y0 = first(y0)) %>% ungroup() %>% pull(y0)
      
      fhist_df = data.frame(trial = factor(1:N), y0 =  y0)
      fhist_df$y = y_fhist
      fhist_df$x = x_fhist
      t = s = seq(0, 1, length.out = D)
      
      if(random_int){
        mod = pffr(y ~ s(trial, bs = "re") + ff(x, xind = s, limits = "s<t"), 
                   yind = t, fhist_df)
      }else{
        mod = pffr(y ~ y0 + ff(x, xind = s, limits = "s<t"), yind = t, fhist_df)
      }
      mod
}

fhist_results = make_pffr(dat, random_int = TRUE)
```

Now plot the results

```{r}
delta_fhist = coef(fhist_results, n1 = 50, n2 = 50)$smterms$"s(trial)"$coef %>%
  as_tibble() %>% 
  select(trial = trial, time = t.vec, lambda = value) %>%
	mutate(trial = as.numeric(trial)) %>%
  arrange(trial) %>%
  pull(lambda) 

dat = simulated_data6$data %>%
  mutate(yhat_flode = flode_results$data$yhat,
         resid_flode = value - yhat_flode,
         yhat_fhist = fhist_results$fitted.values,
         resid_fhist = value - yhat_fhist,
         delta_flode = flode_results$data$deltaStar,
         delta_fhist = delta_fhist)

surface_flode = flode_results$surface[[2]] %>% as_tibble() %>%
  mutate(t = t) %>% select(t, everything()) %>%
  gather(s, value, starts_with("s")) %>%
  mutate(s = surface6$s) %>%
  mutate(value = ifelse(s <= t, value, NA)) %>%  
  mutate(type = "flode")

fhist_surface_re = coef(fhist_results, n1 = 50, n2 = 50)$smterms$"ff(x,s)"$coef %>%
    	select(s = x.smat, t = x.tmat, value = value) %>% as_tibble() 

# interpolate surface so it is on the same grid as flode
interp_obj = list(x = unique(fhist_surface_re$s), y = unique(fhist_surface_re$t),
                  z = matrix(fhist_surface_re$value, 50, 50, byrow = TRUE))

loc_mat = list(x = s, y = t)
surface_re = fields::interp.surface.grid(interp_obj, loc_mat)$z
surface_re[50,] = surface_re[50-1,] # carry last value forward so not NA
surface_fhist = surface_re * lower.tri(surface_re, diag = TRUE) 
colnames(surface_fhist) = colnames(simulated_data6$surface)


surface_fhist = surface_fhist %>%
  as_tibble() %>%
  mutate(t = t) %>% select(t, everything()) %>%
  gather(s, value, starts_with("s")) %>%
  mutate(s = as.numeric(str_remove(s, "s"))) %>%
  mutate(value = ifelse(s <= t, value, NA)) %>%  
  mutate(type = "fhist")

surface_df = bind_rows(mutate(surface6, type = "truth"), surface_fhist, surface_flode)

```


```{r fig_sim_results, fig.height = 14, fig.width = 12}

fitted  = dat %>%
  gather(method, yhat_value, starts_with("yhat")) %>%
  ggplot(aes(time, value, group = trial)) + geom_line(alpha = 0.5, color = "gray") +
  geom_line(aes(y = yhat_value), color = "indianred", alpha = 0.25) +
  facet_wrap(~ method)

resid  = dat %>%
  gather(method, resid_value, starts_with("resid")) %>%
  ggplot(aes(time, resid_value)) + geom_point(alpha = 0.2) +
  facet_wrap(~ method)

delta  = dat %>%
  gather(method, delta_value, starts_with("delta")) %>%
  ggplot(aes(time, reStar, group = trial)) + geom_line(alpha = 0.5, color = "gray") +
  geom_line(aes(y = delta_value), color = "indianred", alpha = 0.25) +
  facet_wrap(~ method)

surfaces = surface_df %>%  
  #mutate(s = round(s, 2), t = round(t, 2)) %>%  
  ggplot(aes(s, t)) + 
  geom_tile(aes(fill = value, col = value)) + 
  scale_fill_viridis_c() +
  scale_colour_viridis_c() +
  facet_wrap(~type) +
  theme(legend.position = "bottom")

fitted  + delta + surfaces + plot_layout(ncol = 1)
```



## aggregate results

load data

```{r}
load(file = "sim_df.RData")
```


## surface errors

```{r fig_sim_surfaceErr}
surface = df %>%
  filter(N == 100) %>% 
  mutate(logsurface = log(surface_err)) %>%
  ggplot(aes(factor(alpha_true), logsurface, group = interaction(method, factor(alpha_true)), fill = method)) +
  geom_boxplot() +
  labs(x = "true alpha", y = "log surface error") +
  theme(legend.title = element_blank(),
        legend.position = c(0.8, 0.6),
        axis.text = element_text(size = 11),
        plot.margin = unit(c(0,1,.1, .1), "cm") ) +
  ggtitle("log surface errors")


sigma = df %>%
  filter(N == 100) %>% 
  mutate(logsurface = log(surface_err)) %>%
  ggplot(aes(factor(alpha_true), sigma, 
             group = interaction(method, factor(alpha_true)), fill = method)) +
  geom_hline(yintercept = 0.1, linetype = 2) +
  geom_boxplot() +
  labs(x = "true alpha", y = "estimated sigma") +
  ylim(0.09, 0.12) +
  theme(legend.title = element_blank(),
        #legend.position = c(0.8, 0.6),
        legend.position = "none",
        axis.text = element_text(size = 11),
        plot.margin = unit(c(0,1,.1, .1), "cm") ) +
  ggtitle("sigma")


surface + sigma

```


```{r fig_sim_alpha}
alpha = df %>%
  filter(method == "flode") %>%
  mutate(alpha_true_num = alpha_true) %>%
  mutate(alpha_true = str_c("alpha = ", alpha_true),
         alpha_true = factor(alpha_true),
         alpha_true = fct_relevel(alpha_true, "alpha = 2", "alpha = 4", "alpha = 6", 
                                  "alpha = 8",
                             "alpha = 10", "alpha = 12")) %>%
  ggplot(aes(alpha_true, alpha, fill = alpha_true)) + 
  geom_hline(aes(yintercept = alpha_true_num), linetype = 2) +
  geom_boxplot() + labs(y = "estimated alpha") +
  scale_fill_viridis(discrete = TRUE) +
  facet_wrap(~alpha_true, ncol = 6, scales = "free") +
  theme(legend.position = "none",
        axis.title.x = element_blank()) 


lambda = df %>%
  filter(N == 100, method == "flode") %>% 
  ggplot(aes(factor(alpha_true), lambda, group = factor(alpha_true), fill = factor(alpha_true))) +
  geom_hline(yintercept = 50, linetype = 2) +
  geom_boxplot() +
  scale_fill_viridis(discrete = TRUE) +
  labs(x = "true alpha", y = "estimated lambda") +
  theme(legend.title = element_blank(),
        legend.position = "none",
        axis.text = element_text(size = 11),
        plot.margin = unit(c(0,1,.1, .1), "cm") ) 

alpha + lambda + plot_layout(ncol = 1)
```

